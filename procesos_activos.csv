import psutil
import pandas as pd
from datetime import datetime

def obtener_procesos():
    procesos = []
    for proc in psutil.process_iter(['pid', 'name', 'username', 'cpu_percent', 'memory_info', 'create_time']):
        try:
            p = proc.info
            procesos.append({
                'pid': p['pid'],
                'nombre': p['name'],
                'usuario': p['username'],
                'cpu': p['cpu_percent'],
                'memoria_MB': p['memory_info'].rss / (1024 * 1024),  # memoria en MB
                'inicio': datetime.fromtimestamp(p['create_time']).isoformat(),
                'es_malicioso': 0
            })
        except (psutil.NoSuchProcess, psutil.AccessDenied):
            continue
    return pd.DataFrame(procesos)

df = obtener_procesos()

# Limpiar campos problem√°ticos
df['nombre'] = df['nombre'].astype(str).str.replace('"', '', regex=False)
df['usuario'] = df['usuario'].astype(str).str.replace('"', '', regex=False)

# Guardar CSV con escape de caracteres
df.to_csv("procesos_activos.csv", index=False, quoting=1)
print("CSV limpio guardado como 'procesos_activos.csv'")
